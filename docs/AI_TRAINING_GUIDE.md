# Как «обучить» ИИ под QadamSafe

В QadamSafe ИИ используется в трёх местах:

| Компонент | Где | Модель | Промпт/логика |
|-----------|-----|--------|----------------|
| **Генерация сценариев** | `backend/index.js` | Groq Llama 3.1 8B | `AI_SCENARIO_PROMPT` + `topicPrompts` |
| **Чат-ассистент (Qadam AI)** | `backend/index.js` | Groq Llama 3.1 8B | `AI_ASSISTANT_SYSTEM_PROMPT` |
| **Анализ текста (SMS и т.п.)** | `frontend/src/services/aiService.ts` | **Нет ИИ** — эвристики по ключевым словам | `SCAM_KEYWORDS` + правила |

Под «обучением» здесь имеется в виду **не** дообучение весов модели (fine-tuning), а **кастомизация через промпты, контекст и данные** — то, что реально сделать в проекте без GPU и больших датасетов.

---

## 1. Улучшение системного промпта (Chat-ассистент)

**Файл:** `backend/index.js` → `AI_ASSISTANT_SYSTEM_PROMPT`

**Что делать:** расширить системный промпт, чтобы ИИ вёл себя как экспертный ассистент именно QadamSafe.

### Что добавить в промпт

- **Миссия продукта:** «QadamSafe — образовательная платформа по кибербезопасности для Казахстана. Ты помогаешь пользователям распознавать мошенничество (SMS, звонки, соцсети), объясняешь основы безопасности и даёшь советы применимо к местному контексту.»
- **Локальный контекст (Казахстан):**
  - Банки: Kaspi, Halyk, Forte, Жилстрой, и т.д.; официальные номера/сайты (Kaspi 7111, egov.kz и т.п.).
  - Сервисы: eGov, ЦОН, OLX, Kolesa, Kaspi Доставка, Glovo, inDriver, Magnum, Kazpost.
  - Номера: +7 (7XX) для Казахстана, типичные форматы.
- **Стиль:** кратко, по делу, без лишнего. Для школьников — проще формулировки; можно спрашивать возраст/роль при необходимости.
- **Ограничения:** не придумывать реальные ссылки или номера; при примерах использовать шаблоны вроде `kaspi-official.kz`, `+7 7XX XXX XX XX`.

### Пример дополнения к `AI_ASSISTANT_SYSTEM_PROMPT`

```text
Контекст QadamSafe:
- Платформа для обучения кибербезопасности, фокус на Казахстан.
- Частая аудитория: школьники, студенты, семьи.

Казахстан — важно:
- Банки: Kaspi (7111, kaspi.kz), Halyk, Forte. Настоящие банки не просят коды по телефону.
- Госуслуги: egov.kz, gov.kz. Фейковые часто: egov-kz.site, egov-kz.com.
- Маркетплейсы: OLX, Kaspi Объявления — мошенники часто просят предоплату «через Kaspi» вне площадки.
- Доставка: Kazpost, Glovo — не просят «подтвердить заказ» по ссылке с картой.

При разборе сообщений: обращай внимание на домены (опечатки, .site/.online вместо .kz), срочность, просьбы перевести деньги или назвать код.
```

Достаточно вставить этот блок в конец `AI_ASSISTANT_SYSTEM_PROMPT` в `backend/index.js`.

---

## 2. Банк знаний (knowledge) и его подключение

Имеет смысл вынести «знания о QadamSafe» в отдельный модуль и подставлять их в системный промпт. Так проще править логику, не трогая весь `index.js`.

### 2.1 Файл знаний (пример)

Создать `backend/knowledge/qadamsafe-context.js`:

```javascript
module.exports = {
  // Фрагмент, который добавляется в system prompt ассистента
  assistantContext: `
Контекст QadamSafe: образовательная платформа по кибербезопасности для Казахстана.

Казахстан, банки и сервисы:
- Kaspi: 7111, kaspi.kz. Не просят коды по телефону/SMS с переходами по ссылке.
- Halyk, Forte: только официальные приложения и сайты.
- eGov: egov.kz, gov.kz. Подделки: egov-kz.site, egov-kz.com, egov.kz-*. 
- OLX, Kolesa, Kaspi Объявления: мошенники часто просят предоплату вне площадки или «для доставки».
- Kazpost, Glovo: не просят «подтвердить заказ» по ссылке с данными карты.
- inDriver, Яндекс: оплата через приложение; просьба перевести «напрямую на Kaspi» — подозрительно.

Красные флаги: срочность, просьбы о коде/SMS, переходах по ссылке, переводе денег «прямо на Kaspi», домены с опечатками.
  `.trim(),

  // Опционально: примеры пар «вопрос — хороший ответ» для few-shot (вставить в промпт по необходимости)
  fewShotExamples: [
    { q: "Что такое 2FA?", a: "2FA (двухфакторная аутентификация) — это когда кроме пароля нужен второй шаг: код из SMS, приложения (Google Authenticator) или биометрия. Например, Kaspi и банки часто просят код из SMS при переводе — это и есть 2FA. Мошенники как раз пытаются выманить этот второй код, притворяясь «службой безопасности»." },
  ],
};
```

### 2.2 Подключение в `backend/index.js`

В начале файла:

```javascript
const { assistantContext } = require('./knowledge/qadamsafe-context');
```

И изменить формирование системного промпта:

```javascript
const AI_ASSISTANT_SYSTEM_PROMPT = `You are QadamSafe AI... 
... (остальной текст) ...

${assistantContext}
`;
```

Если будете добавлять few-shot — можно вставлять `fewShotExamples` в `messages` перед диалогом (1–2 примера, чтобы не раздувать контекст).

---

## 3. Генерация сценариев: промпт и топики

**Файл:** `backend/index.js` — `AI_SCENARIO_PROMPT` и `topicPrompts` (Groq/Llama).

### 3.1 Что улучшить

1. **Единый стиль:**  
   - В `backend` сценарии сейчас только про мошенничество. Можно добавить логику 50/50 (легитимная ситуация / мошенничество) и чёткие правила для `outcomeType`, как было в прежней версии.

2. **Расширение `topicPrompts`:**  
   - Новые темы: поддельные благотворительности, «родственник в беде» с нового номера, фейковые выигрыши (в т.ч. Magnum), «курьер не может найти» + просьба скинуть карту, Kaspi, eGov, OLX, Kolesa, Telegram, работа, Glovo, Kazpost, пирамиды, лотереи, благотворительность, такси.

3. **Few-shot для сценариев:**  
   В `AI_SCENARIO_PROMPT` можно добавить один короткий пример валидного JSON-сценария (1 шаг, 2–3 опции), чтобы модель стабильнее соблюдала структуру. Важно: не перегружать — 1 пример обычно достаточно.

### 3.2 Вынос в knowledge

Рекомендация: вынести `AI_SCENARIO_PROMPT` и `topicPrompts` в `backend/knowledge/scenario-prompts.js` и подключать в `backend/index.js`. Тогда «обучение» сценариев сводится к правке одного модуля.

---

## 4. Анализ текста (aiService): переход на реальный ИИ

Сейчас `frontend/src/services/aiService.ts` — эвристики по `SCAM_KEYWORDS` и жёсткие правила (например, Wildberries+работа+взнос). Это не ИИ.

### 4.1 Вариант: отдельный endpoint анализа

В `backend/index.js` добавить, например, `POST /api/ai/analyze-message`:

- **Вход:** `{ "text": "..." }`.
- **Промпт:** системное сообщение в стиле:  
  «Ты эксперт по кибербезопасности. Проанализируй текст на признаки фишинга/мошенничества. Ответь строго в JSON:  
  `{ "isSafe": bool, "riskLevel": "SAFE"|"LOW"|"MEDIUM"|"HIGH"|"CRITICAL", "summary": "...", "advice": "..." }`»
- **Модель:** та же Groq (Llama), что и для чата.

На фронте в `aiService.analyzeText` заменить эвристики на вызов этого API (с учётом авторизации, как в `/api/ai/chat`). Так «анализатор» тоже будет «обучен» под проект через промпт и общий контекст (Казахстан, банки, типичные схемы).

### 4.2 Альтернатива: чат с ролью «анализатор»

Можно не вводить отдельный endpoint, а в `aiService.analyzeText` вызывать `firebaseAssistantAPI.sendMessage` с одним сообщением вида:  
«Проверь этот текст на фишинг и мошенничество. Ответь в формате: isSafe (да/нет), riskLevel, summary, advice.»  
и парсить ответ. Минус — менее стабильный JSON, плюс — ничего не надо менять в backend.

---

## 5. RAG (Retrieval Augmented Generation) — опционально

Если захочется, чтобы ИИ чаще опирался на «базу знаний» (реальные схемы, FAQ, гайды), а не только на зашитый в промпт текст:

1. **Хранение:**  
   - Тексты (статьи, примеры сценариев, красные флаги по темам) в Firestore (например, коллекция `aiKnowledge`) или в одном/нескольких JSON/Markdown в `backend/knowledge/`.

2. **Поиск:**  
   - При запросе: определять тему (банк, eGov, OLX, пароли и т.д.) по ключевым словам или через один быстрый вызов ИИ.  
   - Выбирать 1–3 релевантных фрагмента из базы.

3. **Вставка в промпт:**  
   - В system или в первое user-сообщение: «Вот релевантная информация: …」 + найденные фрагменты. Дальше — обычный диалог.

Для QadamSafe на первом этапе достаточно качественного системного промпта и `assistantContext`. RAG имеет смысл, когда появятся десятки статей/сценариев, которые хочется использовать как эталон.

---

## 6. Чего избегать (без fine-tuning)

- **Fine-tuning (дообучение) Gemini/Groq** в рамках этого проекта — не требуется. Нет готового размеченного датасета, плюс Groq не даёт дообучять свои модели. Кастомизация через промпты и knowledge даёт основной эффект.
- **Длинные промпты:** system prompt лучше держать в пределах 2–4 тыс. токенов. Если подключаете большой knowledge — режьте на куски и подставляйте только релевантные.
- **Жёсткий JSON в чате:** для `analyzeText` — отдельный endpoint с `response_format: { type: "json_object" }` или чёткой инструкцией «ответь только JSON» удобнее, чем парсить вольный текст.

---

## 7. Краткий чеклист

| Задача | Где | Сложность |
|--------|-----|-----------|
| Расширить `AI_ASSISTANT_SYSTEM_PROMPT` (Казахстан, QadamSafe, банки, eGov) | `backend/index.js` | Низкая |
| Вынести контекст в `knowledge/qadamsafe-context.js` и подключать в промпт | `backend/` | Низкая |
| Добавить few-shot примеры в чат (1–2 пары Q/A) | `backend/index.js` | Низкая |
| Добавить логику 50/50 и расширить `topicPrompts` в backend | `backend/` | Средняя |
| Добавить 1 JSON-пример сценария в `AI_SCENARIO_PROMPT` | `backend/` | Низкая |
| Заменить `aiService.analyzeText` на вызов `/api/ai/analyze-message` или чата | `frontend/aiService.ts`, `backend` | Средняя |
| (Позже) RAG: база знаний + поиск + вставка в промпт | `backend/`, Firestore или файлы | Выше |

---

## 8. Где что лежит

```
QadamSafe/
├── backend/
│   ├── index.js              # AI_ASSISTANT_SYSTEM_PROMPT, /api/ai/chat, /api/ai/generate-scenario (Groq)
│   └── knowledge/            # qadamsafe-context.js, при желании scenario-prompts.js
├── functions/
│   └── index.js              # Auth, scenarios, progress, achievements, classroom (без ИИ)
└── frontend/src/
    └── services/
        ├── aiService.ts      # analyzeText — сейчас эвристики, можно перевести на ИИ
        └── firebase.ts       # firebaseAssistantAPI.sendMessage → backend /api/ai/chat
```

Итого: «обучить» ИИ под QadamSafe в ваших условиях — это в первую очередь **системные промпты, банк знаний (knowledge) и единые топики сценариев**. Fine-tuning не нужен; следующий шаг по мощности — RAG, когда накопится много структурированных материалов.
